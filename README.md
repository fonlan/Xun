# Xun

Xun 是一个基于 Rust + Slint 的 Windows 本地文件快速检索与启动器。

它通过系统托盘和全局快捷键（`Alt+Space`）唤起搜索面板，后台使用 Windows 服务维护文件索引，并通过命名管道向前端提供查询结果。

## 主要特性

- 全局快捷键唤起：`Alt+Space`
- 托盘菜单：安装/卸载系统服务、切换客户端开机启动、退出
- NTFS 高性能索引：基于 MFT 枚举 + USN Journal 增量更新
- IPC 查询：客户端与服务端通过 `\\.\pipe\xun.search.v1` 通信
- 索引状态提示：服务端初始索引未完成时，客户端输入框占位符会提示“后台正在建立索引”
- 服务状态提示：客户端启动且无法连接 IPC 服务端时，输入框占位符会提示“服务端未启动”
- 启动自动拉起：客户端启动时若检测到系统服务已安装但未运行，会立即尝试启动服务；非管理员启动时会触发 UAC 提权后执行启动
- 退出自动停服：客户端退出时会自动尝试停止已安装且正在运行的系统服务；非管理员退出时会触发 UAC 提权后执行停止
- UAC 取消提示：若用户在提权弹窗中取消，客户端会记录明确日志提示“用户取消提权启动”
- 唤起即输入：每次通过热键或托盘唤起窗口后，输入框会立即获得焦点并进入可输入状态
- 查询模式切换：输入框默认“通配”模式（支持 `*` 与 `?`），可通过右侧开关切换到“正则”模式
- 打开历史置顶：客户端会记录曾打开项；后续搜索命中这些项时优先置顶显示
- 文件类型筛选：全部、可执行、压缩、文本、办公、音频、视频、图片、其他
- 结果交互：上下键选择、回车打开、Esc 关闭、失焦自动隐藏

## 技术架构

- `src/main.rs`：启动入口，区分客户端/服务端及服务管理命令
- `src/app.rs`：Slint UI 逻辑、输入防抖、查询线程、结果渲染
- `src/server.rs`：Windows 服务注册与生命周期管理、管道服务
- `src/index.rs`：文件索引与检索核心（前缀 + trigram + 子串匹配）
- `src/ipc.rs`：命名管道协议编解码与重试逻辑
- `src/win.rs`：Win32 桥接（全局热键、托盘、ShellExecute、注册表开机启动）
- `ui/app.slint`：界面定义与交互事件

## 运行环境

- Windows（当前实现依赖 Win32 API 与 NTFS）
- Rust 工具链（建议 stable 最新版）

## 快速开始（开发者）

1. 构建并运行客户端：

```powershell
cargo run
```

2. （可选）通过命令安装并启动后台服务（需要管理员权限）：

```powershell
cargo run -- --install-service
```

> 说明：客户端查询依赖后台索引服务。若服务未运行，输入内容仍可作为路径/命令尝试直接打开，但不会返回索引检索结果。

## 普通用户使用方法

1. 启动程序（双击 `xun.exe`）。
2. 右键系统托盘中的 Xun 图标。
3. 点击“安装系统服务”。

完成后即可正常使用检索能力（`Alt+Space` 唤起）。

## 更新方法

1. 直接退出客户端（退出时会自动尝试停止系统服务）。
2. 在原路径更新可执行文件（覆盖旧文件）。
3. 重新运行程序（启动时会自动尝试拉起系统服务）。

## 命令行参数

程序支持以下参数（均在 `src/main.rs` 中定义）：

- `--install-service`：安装并启动系统服务（需管理员）
- `--uninstall-service`：卸载系统服务（需管理员）
- `--start-service`：启动已安装服务（需管理员）
- `--stop-service`：停止已安装服务（需管理员）
- `--server`：以服务端模式运行（供 SCM 或手动前台启动）

## 开发命令

```powershell
cargo check
cargo fmt
cargo clippy --all-targets -- -D warnings
```

## 日志与排障

- 日志文件：`%AppData%\Xun\logs\xun-YYYY-MM-DD.log`（按日期分割）
- 历史配置：`%AppData%\Xun\config\opened-items.v1`（记录曾打开项，用于结果置顶）
- 如果检索无结果，优先检查：
  - 服务是否已安装并运行
  - 进程是否有足够权限访问卷与 USN
  - 是否仅在非 NTFS 分区查找

## 目录结构

```text
.
├─ src/
│  ├─ main.rs
│  ├─ app.rs
│  ├─ server.rs
│  ├─ index.rs
│  ├─ ipc.rs
│  ├─ win.rs
│  ├─ model.rs
│  ├─ arena.rs
│  └─ xlog.rs
├─ ui/
│  └─ app.slint
├─ build.rs
├─ Cargo.toml
└─ xun.png
```
