import { LineEdit, ListView } from "std-widgets.slint";

export struct ResultRow {
    icon: image,
    path: string,
    meta: string,
}

export component AppWindow inherits Window {
    in property <length> popup-width: 960px;
    private property <length> input-height: 48px;
    private property <length> query-padding-left: 14px;
    private property <length> mode-toggle-width: 40px;
    private property <length> mode-toggle-height: 28px;
    private property <length> mode-toggle-right-gap: 10px;
    private property <length> mode-toggle-gap: 6px;
    private property <length> mode-toggle-input-gap: 8px;
    private property <length> query-right-reserved: root.mode-toggle-width * 3 + root.mode-toggle-gap * 2 + root.mode-toggle-right-gap + root.mode-toggle-input-gap;
    private property <length> panel-padding: 14px;
    private property <length> filter-bar-height: 34px;
    private property <length> filter-item-spacing: 6px;
    private property <length> filter-min-item-width: 92px;
    private property <length> collapsed-height: root.panel-padding * 2 + root.input-height;
    private property <length> expanded-height: 520px;
    private property <length> results-panel-height: root.expanded-height - root.panel-padding * 2 - 12px - root.input-height;
    private property <length> filter-visible-width: root.popup-width - root.panel-padding * 2;
    private property <length> filter-item-width: max(root.filter-min-item-width, (root.filter-visible-width - root.filter-item-spacing * (root.filter-labels.length - 1)) / root.filter-labels.length);
    private property <length> filter-content-width: root.filter-item-width * root.filter-labels.length + root.filter-item-spacing * (root.filter-labels.length - 1);
    out property <length> popup-height: root.show-results ? root.expanded-height : root.collapsed-height;

    width: root.popup-width;
    height: root.popup-height;
    animate height {
        duration: 180ms;
        easing: ease-in-out;
    }

    title: "Xun";
    icon: @image-url("../xun.png");
    background: #00000000;
    no-frame: true;
    always-on-top: true;
    default-font-family: "Microsoft YaHei UI";

    in-out property <string> query;
    in-out property <[ResultRow]> results;
    in-out property <int> selected-index: -1;
    in-out property <int> selected-filter-index: 0;
    in-out property <int> total-match-count: 0;
    in-out property <bool> case-sensitive-mode: false;
    in-out property <bool> regex-mode: false;
    in-out property <bool> full-path-mode: false;
    in-out property <bool> initial-index-ready: false;
    in-out property <bool> service-unavailable: false;
    in-out property <bool> service-starting: false;
    in-out property <bool> searching: false;
    in-out property <float> searching-progress: 0.0;
    in-out property <length> results-viewport-y: 0px;
    in-out property <length> filter-viewport-x: 0px;
    out property <length> results-visible-height: root.results-panel-height - 8px - root.filter-bar-height;
    private property <length> result-row-height: 40px;
    private property <length> result-row-padding-x: 12px;
    private property <length> result-icon-width: 24px;
    private property <length> result-icon-gap: 8px;
    private property <length> result-meta-width: 210px;
    private property <length> result-meta-gap: 10px;
    private property <length> result-safe-inset-right: 1px;
    private property <bool> show-results: root.query != "" && root.total-match-count > 0;
    private property <[string]> filter-labels: ["全部", "可执行文件", "压缩文件", "文本文件", "办公文档", "音频文件", "视频文件", "图片文件", "其他文件"];

    callback query-changed(string);
    callback submit(string);
    callback case-sensitive-mode-toggled(bool);
    callback regex-mode-toggled(bool);
    callback full-path-mode-toggled(bool);
    callback item-activated(string);
    callback item-context-menu-requested(int);
    callback filter-selected(int);
    callback esc-pressed();
    callback drag-window-start();
    callback drag-window-move();
    callback selection-up();
    callback selection-down();
    callback focus-query-input();

    focus-query-input => {
        query_input.focus();
    }

    Rectangle {
        width: parent.width;
        height: parent.height;
        clip: true;
        background: #111A29A6;
        border-radius: 14px;
        border-width: 0px;

        TouchArea {
            width: parent.width;
            height: parent.height;
            moved => {
                if (self.pressed) {
                    root.drag-window-move();
                }
            }
            pointer-event(event) => {
                if (
                    event.kind == PointerEventKind.down
                    && (
                        self.mouse-x <= 10px
                        || self.mouse-y <= 10px
                        || self.mouse-x >= root.width - 10px
                        || self.mouse-y >= root.height - 10px
                    )
                ) {
                    root.drag-window-start();
                }
            }
        }

        VerticalLayout {
            padding: 14px;
            spacing: 12px;

            Rectangle {
                height: root.input-height;
                horizontal-stretch: 1;
                clip: true;
                border-radius: 12px;
                border-width: 0px;
                background: #111A2999;

                Rectangle {
                    x: 1px;
                    y: 1px;
                    width: max(0px, parent.width - 2px);
                    height: max(0px, parent.height - 2px);
                    border-radius: 11px;
                    background: @linear-gradient(180deg, #2A385244 0%, #1A263B5C 100%);
                }

                Rectangle {
                    private property <length> indicator-width: 140px;
                    x: (parent.width + self.indicator-width) * root.searching-progress - self.indicator-width;
                    y: parent.height - 3px;
                    width: self.indicator-width;
                    height: 2px;
                    border-radius: 1px;
                    opacity: root.searching ? 1 : 0;
                    background: @linear-gradient(90deg, #00000000 0%, #7FA6E7CC 44%, #CFE4FFFF 50%, #7FA6E7CC 56%, #00000000 100%);
                    animate x {
                        duration: 80ms;
                        easing: linear;
                    }
                    animate opacity {
                        duration: 140ms;
                        easing: ease-in-out;
                    }
                }

                Text {
                    x: root.query-padding-left;
                    width: max(0px, parent.width - root.query-padding-left - root.query-right-reserved);
                    height: parent.height;
                    text: (query_input.text == "" && query_input.preedit-text == "")
                        ? (root.service-starting
                            ? "服务端启动中，请稍后..."
                            : (root.service-unavailable
                                ? "服务端未启动"
                                : (root.initial-index-ready ? "输入命令或文件名..." : "后台正在建立索引，输入后将逐步返回结果...")))
                        : "";
                    font-family: "Microsoft YaHei UI";
                    font-size: 22px;
                    color: #9FB1CF;
                    vertical-alignment: center;
                    overflow: clip;
                    accessible-role: none;
                }

                query_input := TextInput {
                    x: root.query-padding-left;
                    width: max(1px, parent.width - root.query-padding-left - root.query-right-reserved);
                    height: parent.height;
                    text <=> root.query;
                    font-family: "Microsoft YaHei UI";
                    font-size: 22px;
                    color: #EAF0FF;
                    selection-foreground-color: #EAF0FF;
                    selection-background-color: #476BA0;
                    vertical-alignment: center;
                    single-line: true;

                    accepted => { root.submit(self.text); }
                    edited => { root.query-changed(self.text); }
                    key-pressed(event) => {
                        if (event.text == Key.Escape) {
                            root.esc-pressed();
                            return accept;
                        }
                        if (event.text == Key.UpArrow) {
                            root.selection-up();
                            return accept;
                        }
                        if (event.text == Key.DownArrow) {
                            root.selection-down();
                            return accept;
                        }
                        return reject;
                    }
                }

                mode_toggle := Rectangle {
                    x: parent.width - root.mode-toggle-width - root.mode-toggle-right-gap;
                    y: (parent.height - root.mode-toggle-height) / 2;
                    width: root.mode-toggle-width;
                    height: root.mode-toggle-height;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: root.regex-mode
                        ? #8B73C9
                        : (mode_toggle_touch.has-hover ? #51607A99 : #3A425266);
                    background: root.regex-mode
                        ? #4A3B74
                        : (mode_toggle_touch.has-hover ? #2C344599 : #232A3859);

                    mode_toggle_touch := TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            root.regex-mode = !root.regex-mode;
                            root.regex-mode-toggled(root.regex-mode);
                            root.focus-query-input();
                        }
                    }

                    Text {
                        text: ".*";
                        font-family: "Microsoft YaHei UI";
                        color: root.regex-mode
                            ? #EAF0FF
                            : (mode_toggle_touch.has-hover ? #8D9DBA : #74829D);
                        font-size: 16px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        overflow: clip;
                    }
                }

                case_mode_toggle := Rectangle {
                    x: mode_toggle.x - root.mode-toggle-gap - root.mode-toggle-width;
                    y: (parent.height - root.mode-toggle-height) / 2;
                    width: root.mode-toggle-width;
                    height: root.mode-toggle-height;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: root.case-sensitive-mode
                        ? #6A8ED2
                        : (case_mode_toggle_touch.has-hover ? #51607A99 : #3A425266);
                    background: root.case-sensitive-mode
                        ? #2E4675
                        : (case_mode_toggle_touch.has-hover ? #2C344599 : #232A3859);

                    case_mode_toggle_touch := TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            root.case-sensitive-mode = !root.case-sensitive-mode;
                            root.case-sensitive-mode-toggled(root.case-sensitive-mode);
                            root.focus-query-input();
                        }
                    }

                    Text {
                        text: "Aa";
                        font-family: "Microsoft YaHei UI";
                        color: root.case-sensitive-mode
                            ? #EAF0FF
                            : (case_mode_toggle_touch.has-hover ? #8D9DBA : #74829D);
                        font-size: 16px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        overflow: clip;
                    }
                }

                full_mode_toggle := Rectangle {
                    x: case_mode_toggle.x - root.mode-toggle-gap - root.mode-toggle-width;
                    y: (parent.height - root.mode-toggle-height) / 2;
                    width: root.mode-toggle-width;
                    height: root.mode-toggle-height;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: root.full-path-mode
                        ? #699A76
                        : (full_mode_toggle_touch.has-hover ? #51607A99 : #3A425266);
                    background: root.full-path-mode
                        ? #2E5B3D
                        : (full_mode_toggle_touch.has-hover ? #2C344599 : #232A3859);

                    full_mode_toggle_touch := TouchArea {
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            root.full-path-mode = !root.full-path-mode;
                            root.full-path-mode-toggled(root.full-path-mode);
                            root.focus-query-input();
                        }
                    }

                    Text {
                        text: "Full";
                        font-family: "Microsoft YaHei UI";
                        color: root.full-path-mode
                            ? #EAF0FF
                            : (full_mode_toggle_touch.has-hover ? #8D9DBA : #74829D);
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        overflow: clip;
                    }
                }

                Rectangle {
                    width: 86px;
                    height: 24px;
                    x: mode_toggle.x - self.width - 8px;
                    y: (parent.height - self.height) / 2;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: #4E5F7ACC;
                    background: #1A2435E6;
                    visible: mode_toggle_touch.has-hover;
                    opacity: mode_toggle_touch.has-hover ? 1 : 0;
                    animate opacity {
                        duration: 90ms;
                        easing: ease-out;
                    }

                    Text {
                        text: "切换正则模式";
                        color: #D9E7FF;
                        font-family: "Microsoft YaHei UI";
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        overflow: clip;
                        accessible-role: none;
                    }
                }

                Rectangle {
                    width: 110px;
                    height: 24px;
                    x: case_mode_toggle.x - self.width - 8px;
                    y: (parent.height - self.height) / 2;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: #4E5F7ACC;
                    background: #1A2435E6;
                    visible: case_mode_toggle_touch.has-hover;
                    opacity: case_mode_toggle_touch.has-hover ? 1 : 0;
                    animate opacity {
                        duration: 90ms;
                        easing: ease-out;
                    }

                    Text {
                        text: "切换大小写敏感";
                        color: #D9E7FF;
                        font-family: "Microsoft YaHei UI";
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        overflow: clip;
                        accessible-role: none;
                    }
                }

                Rectangle {
                    width: 98px;
                    height: 24px;
                    x: full_mode_toggle.x - self.width - 8px;
                    y: (parent.height - self.height) / 2;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: #4E5F7ACC;
                    background: #1A2435E6;
                    visible: full_mode_toggle_touch.has-hover;
                    opacity: full_mode_toggle_touch.has-hover ? 1 : 0;
                    animate opacity {
                        duration: 90ms;
                        easing: ease-out;
                    }

                    Text {
                        text: "切换全路径匹配";
                        color: #D9E7FF;
                        font-family: "Microsoft YaHei UI";
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        overflow: clip;
                        accessible-role: none;
                    }
                }
            }

            if (root.show-results) : Rectangle {
                height: root.results-panel-height;
                horizontal-stretch: 1;
                clip: true;
                animate opacity {
                    duration: 130ms;
                    easing: ease-in;
                }

                VerticalLayout {
                    spacing: 8px;

                    Rectangle {
                        height: root.filter-bar-height;
                        background: #00000000;

                        Flickable {
                            width: parent.width;
                            height: parent.height;
                            interactive: true;
                            viewport-width: root.filter-content-width;
                            viewport-height: root.filter-bar-height;
                            viewport-x <=> root.filter-viewport-x;
                            viewport-y: 0px;

                            HorizontalLayout {
                                width: root.filter-content-width;
                                height: root.filter-bar-height;
                                spacing: root.filter-item-spacing;

                                for label[index] in root.filter-labels : Rectangle {
                                    height: root.filter-bar-height;
                                    width: root.filter-item-width;
                                    background: index == root.selected-filter-index ? #36507A : #232A38;
                                    border-radius: 8px;
                                    border-width: 1px;
                                    border-color: index == root.selected-filter-index ? #6E8FC6 : #3A4252;

                                    TouchArea {
                                        width: parent.width;
                                        height: parent.height;
                                        clicked => {
                                            root.filter-selected(index);
                                        }
                                        scroll-event(event) => {
                                            let min-x = min(0px, root.filter-visible-width - root.filter-content-width);
                                            let next = root.filter-viewport-x + event.delta-x + event.delta-y;
                                            root.filter-viewport-x = max(min-x, min(0px, next));
                                            return accept;
                                        }
                                    }

                                    Text {
                                        text: label;
                                        font-family: "Microsoft YaHei UI";
                                        color: index == root.selected-filter-index ? #EAF0FF : #A9B5CD;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                        overflow: elide;
                                    }
                                }
                            }
                        }
                    }

                    if (root.results.length > 0) : results-list := ListView {
                        height: root.results-visible-height;
                        horizontal-stretch: 1;
                        horizontal-scrollbar-policy: ScrollBarPolicy.always-off;
                        viewport-width: self.visible-width;
                        viewport-x: 0px;
                        viewport-y <=> root.results-viewport-y;

                        for item[index] in root.results : row := Rectangle {
                            width: max(0px, results-list.visible-width - root.result-safe-inset-right);
                            height: root.result-row-height;
                            clip: true;
                            background: index == root.selected-index
                                ? #36507A
                                : (result_row_touch.has-hover ? #2A3243 : #202634);
                            border-radius: 8px;
                            animate background {
                                duration: 120ms;
                                easing: ease-in-out;
                            }

                            result_row_touch := TouchArea {
                                width: row.width;
                                height: row.height;
                                pointer-event(event) => {
                                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.right) {
                                        root.selected-index = index;
                                        root.item-context-menu-requested(index);
                                    }
                                }
                                clicked => {
                                    root.selected-index = index;
                                    root.item-activated(item.path);
                                }
                            }

                            Image {
                                x: root.result-row-padding-x;
                                y: (row.height - root.result-icon-width) / 2;
                                width: root.result-icon-width;
                                height: root.result-icon-width;
                                source: item.icon;
                                image-fit: contain;
                            }

                            Text {
                                x: root.result-row-padding-x + root.result-icon-width + root.result-icon-gap;
                                y: 0px;
                                width: max(0px, row.width - root.result-row-padding-x * 2 - root.result-icon-width - root.result-icon-gap - root.result-meta-gap - root.result-meta-width);
                                height: row.height;
                                text: item.path;
                                font-family: "Microsoft YaHei UI";
                                color: index == root.selected-index
                                    ? #F3F8FF
                                    : (result_row_touch.has-hover ? #F0F5FF : #EAF0FF);
                                vertical-alignment: center;
                                overflow: elide;
                            }

                            Text {
                                x: row.width - root.result-row-padding-x - root.result-meta-width;
                                y: 0px;
                                width: root.result-meta-width;
                                height: row.height;
                                text: item.meta;
                                font-family: "Microsoft YaHei UI";
                                color: index == root.selected-index
                                    ? #D6E4FF
                                    : (result_row_touch.has-hover ? #B1C3E2 : #9DB1D6);
                                horizontal-alignment: right;
                                vertical-alignment: center;
                                overflow: elide;
                            }
                        }
                    }

                    if (root.results.length == 0) : Rectangle {
                        height: root.results-visible-height;
                        horizontal-stretch: 1;
                        background: #1E2431;
                        border-radius: 8px;

                        Text {
                            text: "当前筛选条件下无结果";
                            font-family: "Microsoft YaHei UI";
                            color: #8E9AB5;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}
